<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチキャリア料金シミュレーター【家族・最大3社比較版】</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f0f2f5; --accent: #333; --loader: #6c5ce7; --success: #28a745; --info: #17a2b8; --warning: #ff9f43; }
        body { font-family: sans-serif; background: var(--bg); padding: 0; color: var(--accent); line-height: 1.4; margin: 0; }
        
        /* ローダー */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 245, 245, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .cube-loader-preview { width: 50px; height: 50px; position: relative; perspective: 200px; margin-bottom: 20px; }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; animation: rotate 4s infinite linear; }
        .cube-face { position: absolute; width: 50px; height: 50px; background: var(--loader); opacity: 0.8; border: 1px solid rgba(255,255,255,0.2); }
        .front { transform: translateZ(25px); } .back { transform: rotateY(180deg) translateZ(25px); }
        .right { transform: rotateY(90deg) translateZ(25px); } .left { transform: rotateY(-90deg) translateZ(25px); }
        .top { transform: rotateX(90deg) translateZ(25px); } .bottom { transform: rotateX(-90deg) translateZ(25px); }
        @keyframes rotate { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
        
        /* メインレイアウト */
        .container { max-width: 1400px; margin: auto; padding: 15px; }
        
        /* タブメニュー */
        .tab-menu { display: flex; background: white; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; padding: 0 10px; }
        .tab-btn { padding: 15px 25px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; font-size: 1rem; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }

        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .view-switch { display: flex; gap: 5px; }
        .view-switch button { background: #eee; border: 1px solid #ccc; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .view-switch button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .add-btn { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* シミュレーター表示 */
        .simulators-grid { display: flex; gap: 20px; align-items: flex-start; padding-bottom: 20px; }
        .simulators-grid.card-view { flex-direction: row; overflow-x: auto; flex-wrap: nowrap; }
        .simulators-grid.card-view .sim-card { min-width: 380px; max-width: 420px; }
        .simulators-grid.column-view { flex-direction: column; overflow-x: visible; }
        .simulators-grid.column-view .sim-card { width: 100%; max-width: 800px; margin: 0 auto; }
        
        .sim-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); flex-shrink: 0; box-sizing: border-box; position: relative; }
        .sim-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .compare-label { font-size: 0.8rem; background: #eee; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .remove-btn { background: #ff4d4d; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        
        section { margin-bottom: 15px; padding: 12px; border: 1px solid #f8f9fa; border-radius: 10px; background: #fafafa; }
        h3 { font-size: 0.85rem; color: var(--primary); margin: 0 0 10px 0; }
        .badge-area { text-align: center; min-height: 40px; }
        .badge { font-size: 0.75rem; padding: 6px 12px; border-radius: 6px; font-weight: bold; display: none; margin: 5px auto; border: 1px solid; }
        
        select, input { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; margin-top: 10px; }
        .btn { padding: 10px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.75rem; background: #fff; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        
        .estimate-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .val { text-align: right; font-family: monospace; font-weight: bold; }
        .total-row { background: #f6f4ff; color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        /* 家族合計・比較表示用 */
        .summary-card { background: white; padding: 30px; border-radius: 15px; max-width: 600px; margin: auto; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .summary-val { font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 10px 0; }
        
        /* 最大3列比較用スタイル */
        .compare-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
            justify-content: center;
        }
        .diff-box { 
            background: var(--info); 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin-top: 20px; 
            text-align: center;
        }
        
        .comp-detail {
            text-align: left;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #555;
        }
        .comp-detail div {
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .comp-label {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.75rem;
            display: block;
        }
    </style>
</head>
<body>

<div id="loader-overlay"><div class="cube-loader-preview"><div class="cube"><div class="cube-face front"></div><div class="cube-face back"></div><div class="cube-face left"></div><div class="cube-face right"></div><div class="cube-face top"></div><div class="cube-face bottom"></div></div></div><div>データを読み込み中...</div></div>

<div class="tab-menu">
    <button class="tab-btn active" onclick="switchTab('main-tab')">見積もり一覧</button>
    <button class="tab-btn" onclick="switchTab('family-tab')">家族合計</button>
    <button class="tab-btn" onclick="switchTab('compare-tab')">プラン比較</button>
</div>

<div class="container">
    <div id="main-tab" class="tab-content active">
        <div class="controls-bar">
            <div class="view-switch">
                <button id="col-btn">列表示</button>
                <button id="card-btn" class="active">カード表示</button>
            </div>
            <button class="add-btn" id="add-sim">比較を追加 ＋</button>
        </div>
        <div id="sim-container" class="simulators-grid card-view"></div>
    </div>

    <div id="family-tab" class="tab-content">
        <div class="summary-card">
            <h3>世帯全体の合計見積もり</h3>
            <p>1-24ヶ月目 合計（月額）</p>
            <div class="summary-val">¥<span id="fam-total-1">0</span></div>
            <hr>
            <p>25ヶ月目以降 合計（月額）</p>
            <div class="summary-val">¥<span id="fam-total-2">0</span></div>
            <p style="font-size: 0.8rem; color: #666;">※追加されているすべてのカードを合算しています</p>
        </div>
    </div>

    <div id="compare-tab" class="tab-content">
        <div id="compare-error" style="text-align:center; padding:50px; color:#666;">
            比較を行うには、見積もり一覧でカードの<strong>「比較対象」を最大3つまで</strong>チェックしてください。
        </div>
        <div id="compare-display" style="display:none;">
            <div class="compare-grid" id="compare-slots"></div>
            <div id="compare-result-area"></div>
        </div>
    </div>
</div>

<template id="sim-template">
    <div class="sim-card">
        <div class="sim-header">
            <label class="compare-label"><input type="checkbox" class="compare-chk"> 比較対象</label>
            <button class="remove-btn">×</button>
        </div>
        <section>
            <h3>1. 会社・製品</h3>
            <select class="carrier-sel"></select>
            <div class="grid cat-btns"><div class="btn active" data-cat="iPhone">iPhone</div><div class="btn" data-cat="Android">Android</div><div class="btn" data-cat="SIMのみ">SIMのみ</div></div>
            <select class="dev-name"></select>
            <div style="display:flex; gap:5px;"><select class="ins-count"></select><select class="con-type"></select></div>
        </section>
        <section><h3>2. プラン</h3><select class="plan-sel"></select><select class="data-sel" disabled></select></section>
        <section><h3>3. オプション</h3><div class="opt-grid grid"></div></section>
        <section><h3>4. 固定回線</h3><select class="net-sel"></select><select class="net-type-sel" disabled></select><div class="net-opt-grid grid"></div></section>
        <section><h3>5. 割引</h3><div class="disc-area"></div><label style="font-size:0.7rem;">端末値引き(総額)</label><input type="number" class="dev-disc-input" placeholder="0"></section>
        
        <div class="badge-area">
            <div class="badge badge-senior" style="background:#fff3cd; color:#856404; border:1px solid #ffeeba;">★シニア限定：4点同時契約割引適用中！</div>
            <div class="badge badge-child" style="background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb;">最強こども割適用中</div>
        </div>

        <section>
            <table class="estimate-table">
                <thead><tr><th>項目</th><th class="val label-p1">1-24ヶ月</th><th class="val label-p2">25ヶ月～</th></tr></thead>
                <tbody>
                    <tr><td>プラン料</td><td class="val res-plan">0</td><td class="val res-plan2">0</td></tr>
                    <tr><td>製品代金</td><td class="val res-dev">0</td><td class="val res-dev2">0</td></tr>
                    <tr><td>オプション</td><td class="val res-opt">0</td><td class="val res-opt2">0</td></tr>
                    <tr><td>固定回線</td><td class="val res-net">0</td><td class="val res-net2">0</td></tr>
                    <tr><td>割引合計</td><td class="val res-disc">0</td><td class="val res-disc2">0</td></tr>
                    <tr class="total-row"><td>合計</td><td class="val">¥<span class="final-1">0</span></td><td class="val">¥<span class="final-2">0</span></td></tr>
                </tbody>
            </table>
        </section>
    </div>
</template>

<script>
// --- UI・ユーティリティ機能 ---
let instances = [];

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if (event) event.currentTarget.classList.add('active');
    updateCalculations();
}

function updateCalculations() {
    // 家族合計
    let f1 = 0, f2 = 0;
    instances = instances.filter(i => document.body.contains(i.el));
    instances.forEach(i => { f1 += (i.total1 || 0); f2 += (i.total2 || 0); });
    document.getElementById('fam-total-1').textContent = f1.toLocaleString();
    document.getElementById('fam-total-2').textContent = f2.toLocaleString();

    // 比較処理 (最大3つ)
    const checked = instances.filter(i => i.dom.compareChk && i.dom.compareChk.checked);
    const err = document.getElementById('compare-error');
    const disp = document.getElementById('compare-display');
    const slots = document.getElementById('compare-slots');
    const resArea = document.getElementById('compare-result-area');

    // 4つ以上チェックされた場合は制限する警告（任意）
    if (checked.length > 3) {
        alert("比較できるのは最大3つまでです。");
        checked[checked.length - 1].dom.compareChk.checked = false;
        return updateCalculations();
    }

    if (checked.length > 0) {
        err.style.display = 'none'; disp.style.display = 'block';
        slots.innerHTML = '';
        checked.forEach(inst => {
            const div = document.createElement('div');
            div.className = 'sim-card';
            div.style.minWidth = 'auto'; // 比較画面では幅固定を解除
            div.style.padding = '15px';
            div.innerHTML = `
                <h3 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">${inst.dom.carrier.value}</h3>
                
                <div class="comp-detail">
                    <div><span class="comp-label">プラン</span>${inst.dom.plan.value}</div>
                    <div><span class="comp-label">機種</span>${inst.dom.device.value || '選択なし'}</div>
                </div>

                <div class="summary-val" style="font-size:1.8rem; margin:15px 0 5px 0;">¥${inst.total1.toLocaleString()}</div>
                <p style="font-size:0.8rem; color:#777; margin:0;">(${inst.dom.labelP1.textContent})</p>
            `;
            slots.appendChild(div);
        });

        // 2つ以上ある場合のみ差額を表示
        if (checked.length >= 2) {
            const costs = checked.map(c => c.total1 * 24);
            const minCost = Math.min(...costs);
            const maxCost = Math.max(...costs);
            const diff = maxCost - minCost;
            const winnerIdx = costs.indexOf(minCost);
            const posNames = ["1つ目", "2つ目", "3つ目"];
            const winnerPos = posNames[winnerIdx];

            resArea.innerHTML = `<div class="diff-box">
                2年間の最大差額: <span style="font-size:1.5rem">約 ¥${diff.toLocaleString()}</span><br>
                (${winnerPos}のプランが一番お得)
            </div>`;
        } else {
            resArea.innerHTML = '';
        }

    } else {
        err.style.display = 'block'; disp.style.display = 'none';
    }
}

function addSimulator() { 
    const t = document.getElementById('sim-template'); 
    const clone = t.content.cloneNode(true); 
    const container = document.getElementById('sim-container');
    container.appendChild(clone); 
    const ins = new SimulatorInstance(container.lastElementChild);
    instances.push(ins);
}

// ビュー切り替え
document.getElementById('col-btn').onclick = () => {
    document.getElementById('sim-container').className = 'simulators-grid column-view';
    document.getElementById('col-btn').classList.add('active'); document.getElementById('card-btn').classList.remove('active');
};
document.getElementById('card-btn').onclick = () => {
    document.getElementById('sim-container').className = 'simulators-grid card-view';
    document.getElementById('card-btn').classList.add('active'); document.getElementById('col-btn').classList.remove('active');
};
document.getElementById('add-sim').onclick = addSimulator;


// --- データロジック ---

const GAS_URL = "https://script.google.com/macros/s/AKfycbxUj8Ojmgq2H-weGZRui_rdi9W6_y6QSUjbjKY1Lr89IsErmVNqxYZx_walEIs3QoaA/exec"; 
let GLOBAL_DATA = null;

const EXCLUSIVE_GROUPS = {
    'UQ': [["自宅セット", "家族セット"]],
    'Y!mobile': [["家族割引", "おうち割 光セット", "おうち割 でんきセット"], ["PayPayカード割 ゴールド", "PayPayカード割"]],
    'softbank': []
};

async function initApp() {
    try {
        const response = await fetch(GAS_URL, { redirect: 'follow' });
        GLOBAL_DATA = await response.json();
        document.getElementById('loader-overlay').style.display = 'none';
        addSimulator();
    } catch (e) { 
        console.error(e);
        alert("データエラー: " + e.message); 
        document.getElementById('loader-overlay').innerHTML = "エラーが発生しました。<br>再読み込みしてください。";
    }
}

class SimulatorInstance {
    constructor(el) {
        this.el = el; this.selectedOpts = new Map(); this.selectedNetOpts = new Map();
        this.currentCat = "iPhone"; this.netMainPrice = [0, 0];
        this.TYPE_LABELS = { 'mnp': 'MNP', 'new': '新規', 'standalone': '機種変更' };
        this.total1 = 0; this.total2 = 0;
        this.carrierName = "";

        this.initDOM(); this.setupCarrier(); this.bindEvents();
    }

    initDOM() {
        this.dom = {
            carrier: this.el.querySelector('.carrier-sel'), catBtns: this.el.querySelectorAll('.cat-btns .btn'),
            device: this.el.querySelector('.dev-name'), ins: this.el.querySelector('.ins-count'), con: this.el.querySelector('.con-type'),
            plan: this.el.querySelector('.plan-sel'), data: this.el.querySelector('.data-sel'), optGrid: this.el.querySelector('.opt-grid'),
            net: this.el.querySelector('.net-sel'), netType: this.el.querySelector('.net-type-sel'), netOptGrid: this.el.querySelector('.net-opt-grid'),
            discArea: this.el.querySelector('.disc-area'), devDisc: this.el.querySelector('.dev-disc-input'),
            badgeSenior: this.el.querySelector('.badge-senior'), badgeChild: this.el.querySelector('.badge-child'),
            labelP1: this.el.querySelector('.label-p1'), labelP2: this.el.querySelector('.label-p2'),
            compareChk: this.el.querySelector('.compare-chk')
        };
    }

    setupCarrier() {
        Object.keys(GLOBAL_DATA).forEach(c => this.dom.carrier.appendChild(new Option(c, c)));
        for(let i=0; i<5; i++) {
            const s = document.createElement('select');
            s.onchange = (e) => { 
                this.autoCheckOptions(e.target.value);
                this.refreshDiscountOptions(); 
                this.calc(); 
            };
            this.dom.discArea.appendChild(s);
        }
        this.loadCarrier();
    }

    autoCheckOptions(val) {
        if (!val) return;
        const name = val.split('_')[0];
        if (name.includes("最強こども割") || name.includes("最強青春割")) {
            this.dom.optGrid.querySelectorAll('.btn').forEach(b => {
                if (b.textContent.includes("あんしんコントロール")) {
                    if (!b.classList.contains('active')) b.click();
                }
            });
        }
    }

    bindEvents() {
        this.el.querySelector('.remove-btn').onclick = () => { 
            this.el.remove(); 
            updateCalculations(); 
        };
        this.dom.compareChk.onchange = () => updateCalculations();

        this.dom.carrier.onchange = () => { this.selectedOpts.clear(); this.loadCarrier(); };
        this.dom.catBtns.forEach(b => b.onclick = (e) => {
            this.dom.catBtns.forEach(x => x.classList.remove('active')); e.target.classList.add('active');
            this.currentCat = e.target.dataset.cat; this.loadDevices();
        });
        this.dom.device.onchange = () => { this.loadIns(); this.loadOpts(); };
        this.dom.ins.onchange = () => { this.loadCon(); this.loadOpts(); };
        this.dom.con.onchange = () => { this.calc(); this.loadOpts(); };
        this.dom.plan.onchange = () => { this.loadData(); this.refreshDiscountOptions(); };
        this.dom.data.onchange = () => { this.loadDiscounts(); this.calc(); };
        this.dom.net.onchange = () => this.loadNetTypes();
        this.dom.netType.onchange = () => this.updateNet();
        this.dom.devDisc.oninput = () => this.calc();
    }

    loadCarrier() {
        const c = this.dom.carrier.value;
        this.carrierName = c;
        const d = GLOBAL_DATA[c];
        this.dom.plan.innerHTML = '<option value="">プラン選択</option>';
        if (d.plans) {
            [...new Set(d.plans.map(x => x[0]))].forEach(p => this.dom.plan.appendChild(new Option(p,p)));
        }
        this.dom.net.innerHTML = '<option value="">固定回線なし</option>';
        if (d.internets) {
            [...new Set(d.internets.map(x => x[0]))].forEach(n => this.dom.net.appendChild(new Option(n,n)));
        }
        this.updateNetOpts(); 
        this.loadDevices();
        this.loadOpts(); 
    }

    loadDevices() {
        const d = GLOBAL_DATA[this.dom.carrier.value].devices.filter(x => x[0] === this.currentCat);
        this.dom.device.innerHTML = '<option value="">機種選択</option>';
        [...new Set(d.map(x => x[1]))].forEach(n => this.dom.device.appendChild(new Option(n,n)));
        this.loadIns();
    }

    loadIns() {
        const d = GLOBAL_DATA[this.dom.carrier.value].devices.filter(x => x[1] === this.dom.device.value);
        this.dom.ins.innerHTML = '<option value="">回数</option>';
        [...new Set(d.map(x => x[2]))].forEach(n => this.dom.ins.appendChild(new Option(`${n}回`, n)));
        this.loadCon();
    }

    loadCon() {
        const c = this.dom.carrier.value;
        const d = GLOBAL_DATA[c].devices.filter(x => x[1] === this.dom.device.value && x[2] == this.dom.ins.value);
        this.dom.con.innerHTML = '<option value="">区分</option>';
        d.forEach(r => this.dom.con.appendChild(new Option(this.TYPE_LABELS[r[3]] || r[3], r[3])));
        this.calc();
    }

    loadData() {
        const d = GLOBAL_DATA[this.dom.carrier.value].plans.filter(x => x[0] === this.dom.plan.value);
        this.dom.data.innerHTML = '<option value="0">データ量</option>';
        d.forEach(r => this.dom.data.appendChild(new Option(`${r[1]} (${r[2]}円)`, r[2])));
        this.dom.data.disabled = false; this.loadDiscounts();
    }

    loadDiscounts() {
        const carrier = this.dom.carrier.value;
        this.masterDiscounts = GLOBAL_DATA[carrier].discounts.filter(d => parseInt(d[2]) !== 0);
        this.refreshDiscountOptions();
    }

    refreshDiscountOptions() {
        const selects = Array.from(this.dom.discArea.querySelectorAll('select'));
        const carrier = this.dom.carrier.value;
        const p = this.dom.plan.value;
        const currentExGroups = EXCLUSIVE_GROUPS[carrier] || [];

        selects.forEach((s, index) => {
            const currentVal = s.value;
            // 現在のセレクトボックス以外で選択されている割引名を取得
            const othersSelected = selects.filter((_, idx) => idx !== index).map(sel => sel.value.split('_')[0]).filter(v => v !== "0" && v !== "");
            s.innerHTML = '<option value="0">割引なし</option>';
            
            this.masterDiscounts.forEach(d => {
                let name = d[0], price = parseInt(d[2]);
                
                // --- 楽天モバイルの修正 ---
                if (carrier === 'Rakuten') {
                    const allowed = ["最強家族割", "最強こども割", "最強青春割", "最強シニアプログラム"];
                    if (!allowed.some(a => name.includes(a))) return;

                    // 【追加】「最強シニアプログラム」選択時、こども割・青春割を表示しない
                    if (othersSelected.some(o => o.includes("最強シニアプログラム"))) {
                        if (name.includes("最強こども割") || name.includes("最強青春割")) return;
                    }
                    // 逆パターン：こども割・青春割が選択されている時、シニアプログラムを表示しない
                    if (name.includes("最強シニアプログラム")) {
                        if (othersSelected.some(o => o.includes("最強こども割") || o.includes("最強青春割"))) return;
                    }
                }
                
                // --- ワイモバイルの修正 ---
                if (carrier === 'Y!mobile') {
                    if (name.includes("親子割") && p.includes("シンプル3 S")) return;
                    
                    // 【追加】「シンプル3 S」選択時、「おうち割 でんきセット(E)」を表示しない
                    if (p.includes("シンプル3 S") && name.includes("でんきセット")) return;
                }

                // (以下、既存のキャリア別ロジック...)
                if (carrier === 'docomo') {
                    if (p.includes("ahamo")) return;
                    if (p.includes("ドコモポイ活MAX20") && name.includes("長期利用割")) return;
                    if (p.includes("ドコモmini")) {
                        const allowed = ["ドコモ光セット", "home 5G", "dカード割", "ドコモでんき"];
                        if (!allowed.some(a => name.includes(a))) return;
                    }
                }
                
                if (carrier === 'au') {
                    if (p.includes("U12バリュー")) {
                        const allowed = ["U12家族割", "カードお支払い割"];
                        if (!allowed.some(a => name.includes(a))) return;
                    }
                    if (name.includes("U12家族割")) { if (!p.includes("U12バリュー")) return; }
                    if (p.includes("マネ活2") && (name.includes("カードお支払い割") || name.includes("家族割プラス"))) return;
                    if (p.includes("シニアバリュー") && name.includes("家族割プラス")) return;
                }

                if (carrier === 'softbank') {
                    if (p.includes("ミニフィット") && !name.includes("おうち割 光セット")) return;
                    const isLight = p.includes("スマホデビュープラン+ライト4GB");
                    const isBasic20 = p.includes("スマホデビュープラン+ベーシック20GB");
                    if (name.includes("1年おトク割+") || name.includes("60歳以上通話おトク割")) { if (!(isLight || isBasic20)) return; }
                    if (name.includes("デビュー特典")) { if (!isBasic20) return; }
                    if (p.includes("スマホデビュープラン")) {
                        if (!(name.includes("1年おトク割+") || name.includes("60歳以上通話おトク割") || name.includes("デビュー特典"))) return;
                    }
                }

                if (carrier === 'UQ') {
                    if (p.includes("コミコミプランバリュー")) { if (!name.includes("サンキュー応援割")) return; }
                    else if (p.includes("トクトク")) {
                        const allowed = ["自宅セット割", "家族セット割", "au Payカード割", "UQ親子応援割"];
                        if (!allowed.some(a => name.includes(a))) return;
                    } else { return; }
                }

                if (othersSelected.includes(name)) return;
                let isAllowed = true;
                currentExGroups.forEach(group => {
                    const isCurrentInGroup = group.some(g => name.includes(g));
                    if (isCurrentInGroup) {
                        const hasOtherFromGroup = othersSelected.some(other => group.some(g => other.includes(g)));
                        if (hasOtherFromGroup) isAllowed = false;
                    }
                });

                if (isAllowed) s.appendChild(new Option(`${name}(${price}円)`, `${name}_${price}`));
            });
            s.value = currentVal;
        });
    }

    loadOpts() {
        const carrier = this.dom.carrier.value; 
        this.dom.optGrid.innerHTML = '';
        const r = GLOBAL_DATA[carrier].devices.find(x => x[1] === this.dom.device.value && x[2] == this.dom.ins.value && x[3] === this.dom.con.value);
        if (r && r[6] > 0) {
            this.addOpt(`端末保証(+${r[6]})`, r[6], 'W');
        }
        GLOBAL_DATA[carrier].options.forEach(o => {
            if (o[0].includes("保証") && r && r[6] > 0) return; 
            this.addOpt(`${o[0]}(+${o[1]})`, o[1], o[0]);
        });
        this.calc();
    }

    addOpt(t, p, k) {
        const b = document.createElement('div'); b.className = 'btn'; b.textContent = t;
        if(this.selectedOpts.has(k)) b.classList.add('active');
        b.onclick = () => { b.classList.toggle('active'); b.classList.contains('active') ? this.selectedOpts.set(k, p) : this.selectedOpts.delete(k); this.calc(); };
        this.dom.optGrid.appendChild(b);
    }

    updateNetOpts() {
        this.dom.netOptGrid.innerHTML = ''; const added = new Set();
        GLOBAL_DATA[this.dom.carrier.value].internets.forEach(row => {
            if(row[5] && !added.has(row[5])) {
                const b = document.createElement('div'); b.className = 'btn'; b.textContent = `${row[5]}(+${row[6]})`;
                b.onclick = () => this.handleNetGroup(b, row[5], row[6]); this.dom.netOptGrid.appendChild(b); added.add(row[5]);
            }
        });
    }

    handleNetGroup(btn, n, p) {
        const c = this.dom.carrier.value;
        const g = { 'UQ': ['自宅セット割', '家族セット割'], 'Y!mobile': ['おうち割 光セット(A)', '家族割引'], 'docomo': ['ドコモ光セット割', 'みんなドコモ割'], 'au': ['auスマートバリュー', '家族割プラス'], 'softbank': ['おうち割 光セット', '新みんな家族割'] };
        if (g[c]?.includes(n)) {
            this.dom.netOptGrid.querySelectorAll('.btn').forEach(b => {
                const name = b.textContent.split('(')[0];
                if (g[c].includes(name) && b !== btn) { b.classList.remove('active'); this.selectedNetOpts.delete(name); }
            });
        }
        btn.classList.toggle('active'); btn.classList.contains('active') ? this.selectedNetOpts.set(n, p) : this.selectedNetOpts.delete(n);
        this.calc();
    }

    loadNetTypes() {
        const rows = GLOBAL_DATA[this.dom.carrier.value].internets.filter(r => r[0] === this.dom.net.value && r[1] !== "");
        this.dom.netType.innerHTML = '<option value="">区分</option>';
        rows.forEach((r,i) => this.dom.netType.appendChild(new Option(`${r[1]}(${r[2]}円)`, i)));
        this.dom.netType.disabled = false; this.updateNet();
    }

    updateNet() {
        const rows = GLOBAL_DATA[this.dom.carrier.value].internets.filter(r => r[0] === this.dom.net.value && r[1] !== "");
        const r = rows[this.dom.netType.value];
        this.netMainPrice = r ? [parseInt(r[2])+parseInt(r[3]), parseInt(r[2])] : [0,0]; this.calc();
    }

    calc() {
        const c = this.dom.carrier.value; const pName = this.dom.plan.value;
        const insValue = parseInt(this.dom.ins.value) || 24;
        const planP = parseInt(this.dom.data.value) || 0;
        const dataLabel = this.dom.data.options[this.dom.data.selectedIndex]?.text || "";
        const devDInput = parseInt(this.dom.devDisc.value) || 0;
        const devD = Math.floor(devDInput / 24);
        let threshold = (insValue === 36) ? 36 : 24;
        this.dom.labelP1.textContent = `1-${threshold}ヶ月`; this.dom.labelP2.textContent = `${threshold + 1}ヶ月目～`;
        
        let d1 = 0, d2 = 0;
        const r = GLOBAL_DATA[c].devices.find(x => x[1] === this.dom.device.value && x[2] == insValue && x[3] === this.dom.con.value);
        if(r) { d1 = Math.max(0, (parseInt(r[4])||0) - devD); d2 = parseInt(r[5])||0; }
        
        let optT = 0; this.selectedOpts.forEach(v => optT += parseInt(v));
        let netT = 0; this.selectedNetOpts.forEach(v => netT += parseInt(v));
        
        let baseDisc1 = 0, baseDisc2 = 0; const selectedDiscNames = [];
        this.dom.discArea.querySelectorAll('select').forEach(s => {
            const valStr = s.value;
            if(valStr && valStr !== "0") {
                let name = valStr.split('_')[0], price = parseInt(valStr.split('_')[1]);
                if (c === 'au') {
                    if (name.includes("スマートバリュー")) { price = pName.includes("U18バリュー") ? -550 : -1100; }
                    if (pName.includes("U18バリュー") && name.includes("家族割プラス")) { price = (Math.abs(price) === 1210) ? -550 : -220; }
                }
                if (c === 'UQ' && pName.includes("トクトク") && name.includes("親子応援割")) { if (dataLabel.includes("~5GB")) price = -550; }
                if (c === 'Rakuten' && name.includes("最強こども割")) {
                    if (pName.includes("最強U-NEXTプラン")) price = -110;
                    else if (pName.includes("最強プラン")) { if (dataLabel.includes("~3GB")) price = -440; else price = -110; }
                }
                const LIMITED = ["1年おトク割+", "デビュー特典", "応援割", "親子割"];
                const isLim = LIMITED.some(ld => name.includes(ld));
                baseDisc1 += price; if (!isLim) baseDisc2 += price;
                selectedDiscNames.push(name);
            }
        });

        let bonusTotal = 0, showS = false, showC = false;
        if (c === 'Rakuten') {
            if (selectedDiscNames.some(t => t.includes('こども'))) showC = true;
            const isSenior = selectedDiscNames.some(t => t.includes('シニア'));
            const optK = Array.from(this.selectedOpts.keys());
            if (isSenior && optK.some(n=>/通話/.test(n)) && optK.some(n=>/操作サポート/.test(n)) && optK.some(n=>/ノートン/.test(n)) && optK.some(n=>/Whoscall/.test(n))) {
                bonusTotal -= 1100; showS = true;
            }
        }
        this.dom.badgeSenior.style.display = showS ? 'block' : 'none';
        this.dom.badgeChild.style.display = showC ? 'block' : 'none';

        const finalDisc1 = baseDisc1 + bonusTotal;
        const finalDisc2 = baseDisc2 + (showS ? -1100 : 0);

        this.el.querySelector('.res-plan').textContent = planP.toLocaleString();
        this.el.querySelector('.res-plan2').textContent = planP.toLocaleString();
        this.el.querySelector('.res-dev').textContent = d1.toLocaleString();
        this.el.querySelector('.res-dev2').textContent = d2.toLocaleString();
        this.el.querySelector('.res-opt').textContent = optT.toLocaleString();
        this.el.querySelector('.res-opt2').textContent = optT.toLocaleString();
        this.el.querySelector('.res-net').textContent = (this.netMainPrice[0]+netT).toLocaleString();
        this.el.querySelector('.res-net2').textContent = (this.netMainPrice[1]+netT).toLocaleString();
        this.el.querySelector('.res-disc').textContent = finalDisc1.toLocaleString();
        this.el.querySelector('.res-disc2').textContent = finalDisc2.toLocaleString();
        
        this.total1 = Math.max(0, planP + d1 + optT + this.netMainPrice[0] + netT + finalDisc1);
        this.total2 = Math.max(0, planP + d2 + optT + this.netMainPrice[1] + netT + finalDisc2);

        this.el.querySelector('.final-1').textContent = this.total1.toLocaleString();
        this.el.querySelector('.final-2').textContent = this.total2.toLocaleString();
        
        updateCalculations();
    }
}

initApp();
</script>
</body>
</html>



